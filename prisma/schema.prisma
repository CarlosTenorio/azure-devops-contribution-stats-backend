generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id   String @id @default(uuid())
  name String

  invitations         Invitation[]
  organizationMembers OrganizationMember[]
  teams               Team[]

  ownerUser   User?   @relation("CompanyOwner", fields: [ownerUserId], references: [id])
  ownerUserId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invitation {
  id    String  @id @default(uuid())
  email String
  token String  @unique
  used  Boolean @default(false)

  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id         String     @id @default(uuid())
  name       String?
  email      String     @unique
  status     UserStatus @default(PENDING_TO_ACTIVATE)
  connection String
  oauthId    String     @unique

  companyOwner Company? @relation("CompanyOwner")

  stats YearlyStats[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserTeam {
  id   String @id @default(uuid())
  name String

  team   Team?   @relation(fields: [teamId], references: [id])
  teamId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Team {
  id        String @id @default(uuid())
  name      String
  companyId String

  company Company    @relation(fields: [companyId], references: [id])
  users   UserTeam[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationMember {
  id          String  @id @default(uuid())
  azureId     String  @unique
  displayName String
  email       String  @unique
  imageUrl    String?
  uniqueName  String  @unique

  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model YearlyStats {
  id                       String        @id @default(uuid())
  userId                   String
  year                     Int
  commentsRatePerPRPercent Int           @default(0)
  prCommentsMade           Int           @default(0)
  prsClosed                Int           @default(0)
  prsReviewed              Int           @default(0)
  workItemsAssigned        Int           @default(0)
  workItemsCreated         Int           @default(0)
  reposMostActive          Json          @default("[]")
  pullRequests             PullRequest[]
  user                     User          @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, year])
  @@index([year])
}

model PullRequest {
  id                 String            @id @default(uuid())
  closedDate         DateTime
  codeReviewAzureId  String
  pullRequestAzureId String
  repositoryAzureId  String
  repositoryName     String
  repositoryUrl      String
  status             PullRequestStatus
  title              String
  yearlyStatsId      String
  yearlyStats        YearlyStats       @relation(fields: [yearlyStatsId], references: [id])

  @@index([yearlyStatsId])
  @@index([closedDate])
}

enum PullRequestStatus {
  ABANDONED
  ACTIVE
  COMPLETED
  NOT_SET
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING_TO_ACTIVATE
}
