generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                                          String @id @default(uuid())
  name                                        String
  minPRsClosedToBeGoodContributor             Int    @default(80)
  minPrsReviewedToBeGoodReviewer              Int    @default(200)
  minWorkItemsCreatedToBeGoodContributor      Int    @default(200)
  minWorkItemsAssignedToBeGoodContributor     Int    @default(200)
  minCommentsRatePerPRPercentToBeGoodReviewer Int    @default(15)
  projectURL                                  String

  invitations         Invitation[]
  organizationMembers OrganizationMember[]
  teams               Team[]

  ownerUser   User?   @relation("CompanyOwner", fields: [ownerUserId], references: [id])
  ownerUserId String? @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invitation {
  id    String  @id @default(uuid())
  email String
  token String  @unique
  used  Boolean @default(false)

  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id         String     @id @default(uuid())
  name       String?
  email      String     @unique
  status     UserStatus @default(PENDING_TO_ACTIVATE)
  connection String
  oauthId    String     @unique

  companyOwner Company? @relation("CompanyOwner")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Team {
  id        String  @id @default(uuid())
  name      String
  expanded  Boolean @default(false)
  companyId String

  company Company              @relation(fields: [companyId], references: [id])
  users   OrganizationMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrganizationMember {
  id          String  @id @default(uuid())
  azureId     String  @unique
  displayName String
  imageUrl    String?
  uniqueName  String  @unique

  company   Company? @relation(fields: [companyId], references: [id])
  companyId String?

  teams Team[]
  stats YearlyStats[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model YearlyStats {
  id                       String             @id @default(uuid())
  organizationMemberId     String
  year                     Int
  commentsRatePerPRPercent Int                @default(0)
  prCommentsMade           Int                @default(0)
  prsClosed                Int                @default(0)
  prsReviewed              Int                @default(0)
  workItemsAssigned        Int                @default(0)
  workItemsCreated         Int                @default(0)
  reposMostActive          Json               @default("[]")
  pullRequests             PullRequest[]
  organizationMember       OrganizationMember @relation(fields: [organizationMemberId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationMemberId, year])
  @@index([year])
}

model PullRequest {
  id                 String            @id @default(uuid())
  closedDate         DateTime
  codeReviewAzureId  String
  pullRequestAzureId String
  repositoryAzureId  String
  repositoryName     String
  repositoryUrl      String
  status             PullRequestStatus
  title              String
  yearlyStatsId      String
  yearlyStats        YearlyStats       @relation(fields: [yearlyStatsId], references: [id])

  @@index([yearlyStatsId])
  @@index([closedDate])
}

enum PullRequestStatus {
  ABANDONED
  ACTIVE
  COMPLETED
  NOT_SET
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING_TO_ACTIVATE
}
