generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teams     Team[]
  users     User[]
}

model User {
  id         String        @id @default(uuid())
  name       String?
  email      String        @unique
  status     UserStatus    @default(PENDING_TO_ACTIVATE)
  companyId  String
  teamId     String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  connection String
  oauthId    String        @unique
  company    Company       @relation(fields: [companyId], references: [id])
  team       Team?         @relation(fields: [teamId], references: [id])
  stats      YearlyStats[]
}

model Team {
  id        String   @id @default(uuid())
  name      String
  companyId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  company   Company  @relation(fields: [companyId], references: [id])
  users     User[]
}

model YearlyStats {
  id                       String        @id @default(uuid())
  userId                   String
  year                     Int
  commentsRatePerPRPercent Int           @default(0)
  prCommentsMade           Int           @default(0)
  prsClosed                Int           @default(0)
  prsReviewed              Int           @default(0)
  workItemsAssigned        Int           @default(0)
  workItemsCreated         Int           @default(0)
  reposMostActive          Json          @default("[]")
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  pullRequests             PullRequest[]
  user                     User          @relation(fields: [userId], references: [id])

  @@unique([userId, year])
  @@index([year])
}

model PullRequest {
  id                 String            @id @default(uuid())
  closedDate         DateTime
  codeReviewAzureId  String
  pullRequestAzureId String
  repositoryAzureId  String
  repositoryName     String
  repositoryUrl      String
  status             PullRequestStatus
  title              String
  yearlyStatsId      String
  yearlyStats        YearlyStats       @relation(fields: [yearlyStatsId], references: [id])

  @@index([yearlyStatsId])
  @@index([closedDate])
}

enum PullRequestStatus {
  ABANDONED
  ACTIVE
  COMPLETED
  NOT_SET
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING_TO_ACTIVATE
}
